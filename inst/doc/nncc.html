<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>nncc: nearest-neighbors matching for case-control data</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">nncc: nearest-neighbors matching for
case-control data</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(nncc)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">data</span>(anifood)</span></code></pre></div>
<div id="prepare-the-data" class="section level2">
<h2>1. Prepare the data</h2>
<p>Case-control studies often collect many exposures but have relatively
small sample sizes in comparison to the number of exposures.
Conventional analysis techniques like multivariate logistic regression
can only accommodate a limited number of exposures. The
<code>nncc</code> package was designed to help address this limitation.
<code>nncc</code> matches a case to its nearest available neighbors
based on a user-defined measure of distance (by default Gower distance)
calculated using all collected confounders for a given exposure. In the
end, <code>nncc</code> creates a matched data set for each exposure of
interest.</p>
<p>Ideally, one prefers to follow the analysis plan pre-defined at study
design. Decisions to change your analysis plan to this approach should
be considered carefully in light of how they may affect bias and
uncertainty in model estimates. In addition, constructing variables are
a routine and sometimes necessary part of multifactor studies. However,
constructing new outcome variables from primary variables will increase
dependencies and the difficulty of interpretation, especially where
there is missingness of data.</p>
<p>For illustration, we created a toy example case-control data set
called <code>anifood</code> which only contains 250 cases, 250 controls,
and 11 variables including the one indicating case status,
<code>case</code>, which equals 0 for controls, 1 for cases.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">dim</span>(anifood)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co">#&gt; [1] 500  11</span></span></code></pre></div>
<p>In addition to the data set, <code>nncc</code> needs to know the
exposures of interest, the variables used for matching, and a data set
that contains variables to be excluded from matching for each exposures
(e.g., possible intermediates in the pathway between an exposure and
case status).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># exposures of interest. In a real study, this list can be much longer</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>exp_interest <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;exp01&quot;</span>,<span class="st">&quot;exp09&quot;</span>, <span class="st">&quot;exp27&quot;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co"># exposures to be controlled for any exposure of interest</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>exp_match <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(anifood), <span class="st">&quot;case&quot;</span>)</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co"># variables to be excluded from matching for each exposure</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co"># both exp_var and rm_vars are character variables</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>excl_vars <span class="sc">%&gt;%</span> head</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt;   exp_var            rm_vars</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt; 1   exp01             exp09 </span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co">#&gt; 2   exp09       exp24 exp27 </span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co">#&gt; 3   exp27 exp43 exp45 exp50</span></span></code></pre></div>
</div>
<div id="establish-a-threshold-for-distance" class="section level2">
<h2>2. Establish a threshold for distance</h2>
<p>The first step is to establish a proper distance threshold for
matching. If too loose, there will be poor confounding control; if too
tight, it will be difficult to find enough controls for the cases due to
overmatching.</p>
<p>The <code>get_threshold</code> function uses the maximum bipartite
graph algorithm to find each case’s closest control while ensuring each
control is used no more than once. Then, for each case, a control is
selected randomly.</p>
<p>A logistic regression on whether the control is the closest or the
randomly selected one based on the distance is created. By default, the
threshold used is the distance at which the probability is at least 50%
that the control is the closest vs. a randomly selected one (see the
plot below generated by the function <code>threshold_model_plot</code>).
You can choose a different probability with the <code>p_threshold</code>
argument.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>threshold_results <span class="ot">&lt;-</span> <span class="fu">get_threshold</span>(anifood, exp_match, <span class="at">p_threshold =</span> <span class="fl">0.50</span>)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">#&gt; case</span></span></code></pre></div>
<p>The <code>distance_density_plot</code> function plots the density
distribution of Gower distances for the maximum bipartite graph
algorithm matches (solid line), the density distribution of distances
for the random matches (dashed line), and the threshold (red dashed
line). As expected, a maximum bipartite graph algorithm matching results
in closer matching than a random matching.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">distance_density_plot</span>(threshold_results) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Example of distance_density_plot&quot;</span>)</span></code></pre></div>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAkAAAAGACAMAAAByRC0tAAABLFBMVEUAAAAAADoAAGYAOmYAOpAAZmYAZrYzMzM6AAA6ADo6AGY6OgA6Ojo6OmY6OpA6ZmY6ZpA6ZrY6kLY6kNtNTU1NTW5NTY5NbqtNjshmAABmADpmAGZmOgBmOjpmZgBmZjpmZpBmkLZmkNtmtttmtv9uTU1uTW5uTY5ubqtuq+SOTU2OTW6OTY6OyP+QOgCQOjqQZgCQZjqQkDqQkGaQtpCQttuQ27aQ29uQ2/+rbk2rbm6rbo6ryKur5P+2ZgC2Zjq2kDq2kJC2tra225C227a229u22/+2/9u2///Ijk3I///bkDrbkGbbtmbbtpDbtrbb25Db/7bb/9vb///kq27k///r6+vy8vL/AAD/tmb/yI7/25D/27b/29v/5Kv//7b//8j//9v//+T///+jPsHhAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAZIElEQVR4nO2dC3vcuHWGObY7q92kyW4lr6PEadpau5t1YrXppq03WU+SpuvKniRNalv1eBzJMv//fygAEiR4xx2HnO97HklzIT4cAC+BQw45ynIIclCWOgBo3gJAkJMAEOQkAAQ5CQBBTgJAkJMAEOQkAAQ5KSVA20xqbVr05vzWxfgW1/dbtvujdafYzbemFTfFPSdUVKlTUadNrtFF0WIB2jDbY/WFHoDe3jeuuCldgLQqarfJObooSgvQmW3RSYDYBo+br/QMtsb4j0vXQGu7dpuco4ui5QJ050XzFQAURFQA2oplbMNXnbc/ZqvP7X8TPfrfv8myT/KbX7DfjIeNeP63T6vMgj1b/aMCys1vjrIV33LHF8YKIe74yZ/lEsY3yj5+Wm501qjwzp/vZ6t/kmU+flGYtmppeiobKOWrSniVRUW7YkndHzVW1m6b1CZY72HRRAWgm/PVY9ZnbMx3ZV50xnv07/mjB+dZkdBsiudsS9HZ16dZgxOROHMWLpoA7Y/4s+9LgDZio1sXcojUCotHx7IMd+jU0vJUNlDKV5XUAF2fCo/tqrG2ttvUbAIAGlOVRPMuZfD877noxhWfCzYZH+7s1tP8j2xsnuZ/4AO0yVYP5FuCBLanst2/2qM3fMu353wyU5cwsd0fj8pi16e3n3KTs3KRaFZ45+nNb4uqPnnBnM7ybi0tT2WDunxdiYi0WI02vJ3ttbXTpqoJWMKm1ACIdd13laOxXTGeZ+XcxHZz0bt8j+QdXZAgNq9HRGxT/lHGaX9U7PnlGO2PGJXynXaFRVUcgDtiFTnOO7W0PZUN6vJ1JQpAYvFqrWCdNtVNAEBTaibRbCUok8i//s/vfnJUjWeZGojds9iA7ckFCSV/MveUPb4RE1k14FXusS7HiRX5+Fu1QF0htyoAkIPXqaXtqWxQl68rUQASMbVWsE6b6iYAoCm1jsI2xQT09r48N6Sg0wCIlasyC3OAREqeZbcfywLtCpsAdWppeyob1OXrShSAODydo8NmmwCQiZoA7Yqcke27t//hP7/djQDU2lsraQLEzH73Y5H0ljlQq8L2DNQ3jI0ZqNpAAaiqRAWILV/tFQwzkIMaALHu+/2RHNQ6Y2kCJArwBEHJF2oN5EDy6CdTz0Rf35fj2qmwzoGKR31nnBRPZYMGQGUlKkAsqN+2VrD+NiEH0lIDoC3bp/lpIJF+8jMrvQCxAyZxiFIfsbBDoQqVwaOw9Yv8TzLJ2YlSfypgFb9aFQoA+KHVzaY4IG/V0vJUNqjL15WUABWld6vvtM9v9rVJHoW1t6UoEkdhmTg2uij3w/I1OR4qQKvvKGdX5AmYep8uXyi2V04PnarngWQFZ8UbDzoVCoCK1Lh42qql5als0Eqis0wexouKilKtFWygTbLiBwG734+oAFTM5GIdYenn6uP/OpU5aQOg/yjPSZcv/qI83StVncZtHna/5aXqJJqfJOYnnvP8D0f87E2rwmIJUs5Et2tpeiobqEm0rKR4TVQkT0k01GlT1QRZiLZmdT3QptP9M1OdHlWae5sAUESxTKvz2cTc2wSAtFWd8LH8jIrnRWICahgBoIiaN0DsCOv2044RAIIOWgAIchIAgpwEgCAnASDISQAIcpIhQJc96n3RUAYer90tfIQR0iNUGACICwBZewAgLgBk7QGAuACQtQcACmxBxQMAeWlufAsqHgDIS3PjW1DxAEBemjsg5EDWHgAosAUVDwDkpbnxLah4ACAvzY1vQcUDAHlp7oCQA1l7ACAuAGTtAYC4AJC1B1GAsiwL0twBASBrD6IAsRedCSLc6wk8AJCX5sa3oOJxeAA5E0S41xN4ACAvzR0QciBrD8IAuRJEuNcTeAAgL82Nb0HFY8EARTCCZiVvJxLdpiDkQJ4tqM5AI6E6EQSAPFsAoEEBIGsPAMQFgKw9AFBgCyoehwmQE0GEez2BBwDy0tz4FlQ8DhQgF4KQA3m2AEApLKh4ACAvzY1vQcXjUAFyIIhwryfwAEBemjsg5EDWHgCICwBZe5AHyJ4gAOTZAgANCgBZewCgwBZUPACQl+bGt6DiAYC8NDe+BRUPAOSluQNCDmTtAYACW1DxOFyArAki3OsJPACQl+bGt6DiAYC8NHdAyIGsPQAQFwCy9pgBQLYEASDPFgBoUADI2gMABbag4gGAvDQ3vgUVj0MGyJIgwr2ewAMAeWnugJADWXsAoMAWVDwAkJfmxreg4nHQANkRRLjXE3gAIC/NHRByIGsPAMQFgKw9ogN09cXzPH95cnLy6XMAFNFjKQC9EeA8e6S8pBEqAKJgQQGgZ3e/YTPQ+189oQVQQAsqHgsBqFjC3j1kS5iYhD5gcnWElqZJgK4+f6LMQhqsYwaiYEFnBhKq8iCdUG0IQg7k2QIApbCg4rEogN7ce5W//7XBYTwAomBBByB+HuhudSCmEyoAImBBA6CudEJFDkTAYs4A2RAEgDxbAKBBASBrDwDEBYCsPQBQYAsqHocOkAVBhHs9gQcA8tLc+BZUPACQl+YOCDmQtQcACmxBxQMAeWlufAsqHgcPkDlBhHs9gQcACgkQciBrDwDEBYCsPQAQFwCy9gBAXADI2gMABbag4gGAAFBqCwBkLCKDT7kpAIgLOZC1BwAKbEHFAwAZE0S41xN4ACAAlNoCAA0KOZC1BwDiAkDWHgCICwBZe8wIIFOCAJBnCwBkLCKDT7kpACiwBRUPAASAUlsAoEEhB7L2mBNAhgQR7vUEHgDoEgAltqAKEAFjiJTmNwMhB7L2AEBcAMjaY1YAmREEgDxbAKBBASBrDwAU2IKKBwDiAkApLQCQsYgMPuWmACAu5EDWHgAosAUVDwDEBYBSWgAgYxEZfMpNAUBcyIGsPQAQFwCy9pgXQEYEASDPFgBoUADI2gMABbag4gGAhABQQgsAZCwig0+5KTMDyIQg5ECeLQCQsYgMPuWmAKDAFlQ8AFAhAJTOAgANCjmQtcfcADIgCAB5trAAaP/h48nxf/sUAHkKI6QHWYB6NgFABD0AUKkgAAW0oOIRGaCb8yxbF3SUD/P9UZZlZ8Vbty7kc/77GADR94gL0M35Or8+PeMA8Yf8R8w0+6Mz/jjf3nkhn2MGmodHXIAkFezvjs827Nf+owvxknjO4JLPFwEQciBrj/4xFZSUAN15UVCyKVaybSZ0LJ9PAHR9uppKo8yaixkomYUjQBwGlvxs+XMJB3s+OQMx0OoiACiVR7oljM8gEii2dO3UGYUvZdNLGAOtk2gDoMge8ZPoMnOWDwVD4jmbTxhF8jnPtScAKhAqGSQJEHIga4+BQe05jN+xzIfPPvy5mJXK5xvx7hhAW2GwGVrIDJurTRAA8myR5rMwzpuYo8pl8OqL53n+7uHJvVcAKKbHXAG6Pm0uXW9OPn2ev//6Uf7yBwAopsd8AVKnn/zZ3W/YDPTu58+LmYgKQAEtqHgsBKBiCbv66av83c+esGcfMDm4Q4tUPcTlWccsqxNtDtCbexIgLtP9RXcKIrzbJvCY+QxUqzkDEQEIOZC1R2iAOrpyzYEwA6WyiA8Qm374KUSuRg70/usv7Y/CAFAqCwOA/q9fpgD1yfk8EABKZWECUNYrHwB1ZdxcTYKQA3m2MAKobwKyAqhYxgY/CANAkTxmC9BmnW9vXWzbn5cBoMgecwWITUDVZ/kAKKHHjAG6Pj2mDlBACyoecwXo5vyYX4K28bmEaRJEuNcTeMwVIH73z3r4WiAAFMuDGEDynoxpgKZl3lzvACEHsvawA2g3elw+P4ACWlDxIAXQZvVL7RlI3MA6ckU0AIrjQQoggyVM3Mg6LvPmAqAkFkkA6rlpgyBAyIGsPUIDdHMOgEh4zBWg0VOIACiex1wB6lwPBIDSeMwVIA2ZNxdJdBKLNGeiQwCkRxDhXk/gMV+Atll2tvX7UQYASmKR6HqgO38pruigDBByIGuP0ACJyznO/F7OgRkojQUAMhaRwafclCGAvF1Uv+VLGL+mzCdAWgQR7vUEHpEB6pcNQOJ7hMa+oIwCQMiBrD0GAMrYGtb9sQJoUjbNBUAJLBLNQACIhAeFJNoGILGAZaMfqNo0FwAlsEhwFHZzLo6+rk89n0jUIohwryfwoLCEmQMkz0DfnHs+CgNACSzi50D1xUBjn2VYNRcAxbeInwPVlyN6PpHoGyDkQNYeJgApYIz+94L5ARTQgooHhSVMgsFXprFvS4gBkAZBhHs9gQcFgOQSdv2ji9ErygAQQQ8KS5gEaP+9F/n1D4f/i5O61ElNXhltKq/f9vvapxk0lQPx/wClBZCe7PYXrzMQkmhrjwGARnMg7RkIANHxoACQcQ4EgOh4UMqB+HllraOw2QAU0IKKBwWAjM8DASA6HhSWMELXAwGgBBZLuh7oUoMg5ECeLZJcDzQPgAJaUPGgABCpJQwARbdYVg4EgKJbGAHUd1X9cpcw5EDWHmZjTQmgSYIAkGcLADQoAGTtAYC4AJC1BwAKbEHFAwB1NUEQ4V5P4AGAugJAcS0A0KCQA1l7AKDAFu4erJmZ7j8aDhjGgAcACmzhzcORIQDUo/E+XQJA5dRDuCkAiKs/B8qy3MPi4XHkXGIBQD0KCVBWWTgy5DByVcWYgeYHUMOCzK5vHwgA6lEwgKRx0hxIaR1mIOIATVuQ2fVtAwFAPQoEUG2bEKBGhZiBZgVQvwWZXd8uEADUoyA5kGqa/DxQnwcA8gbQeF96n/cjjlyrKixhAMhjHFaBAKA++Qeo6ZhoCes0CzMQcYB0L+eIs+t3awFAgQAaHVELgNp2aWYgDYDMSV4WQC9PTk4+fU4PoGkLOiMX34IQQM8eKU9cmguAIlrQAej9r57QAmjILMXg9zWpx8OU5EUB9O4hW8LEJPQBU9i6fCt6hQeoyT6++vyJMgs57S8jOyLheX9Y/e0h3JQkAAlVeZBTc/0A9HrAqdfCcPEINXJEwpg7QCP9GGq3DTpymIF0AHpz71X+/tc+DuNTABTSY6A1/R5GJC8KIH4e6G51IObW3GUBZORxwAA15NZcLwC9Nls6SIxcfAsANCjDW5tDATToO+RhEAgAGlAKgIwUsikAaK4ABRm5WaZzAGjMJC5AFh76cQCgIRknDkEshkXEAwANKeToExl8yk0BQFwWSbT24hH4wgLdOADQoIwTGM3y4xbeAQrsAYAG5QiQ10uK6HoAoEGlAkhzDtILw/4eSa9hmHssACCzTyB7ZXUiMfHIxbcAQIOicSY6qAcAGtYCAHL6vlCtqRAADcsFoKKsHUB6axhmIPIAze8yvgQezhbZZQaATDVloTMHaYTh/L/zNOJw6o3yu84BkF5BfQtPADl7hAZoxOOwAZJKnkSH97C2UL7lGACZKs7gT88fkx4eLDQEgLTK+bWY9wzU/JL1xQLUP4xRen3ZAGl80x4A4kqZA0U6krNpSvufPACgoUIuADmOXKzTyMiBRqV9Y3t/EQDUI71vuwFAXEs4jHf6OM0+jIUA1Nd9hOf9WtE+Twu1Sx4sQB6XDocvzI93TRFmoHGZAuRzz3cASFMe4gh1fcOhAtTUEnKg8BYAyFi6FoFvyQFA5ACa1/XMuh6ebjAxutNuKQCZfUdv6rvxEngseAYiUOnrJLUH6CcPlgS+xzjJDNSdVZyT6EzIPBLNMOJ+w8eCZyBPzdUHqDtyXYAKdPLqkXn1U2GYkBkPIONTAQcIUE8ftQCqkMlbz20UOQdy/aYA0zCWA1Cn66x3/RqXvOc1UwGgpQE0ZaP45AOva9XvFoZvD63PYy0+kF0QQDrXzxma5MNvTVY/HobZhObhcwjMQNPSAqi3e6scqLUPtiyslrHZzEB2V+ceHEAmDh2LiTle+8JIUxINm2JxdZR1GAcG0AQA02mU+SSUYAYCQGIozQ98Rtcf0+IDFsZz0DyWMK3OnhFA8kUziKwBej1QVe8kNhaSlkf4WSwix8QBEr2h3+FTt8ENORn9w7mQR1DhPA4YoEsDhtTtjGag/hosAJo8IW5zKOfh4oRRC4erW+YBkHYjRwEadnhtdhLQaGElcirgsGcgLr2eHziNrF9qKozpYEYPBu0+EvFwYn7YQj+ieQN0qdX7VgAZf5Lu2uumwgzkB6DL6YEbBGgYvhEsR3p9dA4aWkltP5H1/qnMwEYWYcwNoEnVHWJwBYzNXRm6ixHpGcj9gHJ+AE0NXM+1GKMdZX8lut4klHdfMpYtQHYZoVEY8wNoSr0ADW/tcDeeHhGkZyB3j3kCpHU2WOsKmPG3pyzGzwhllUdmn/5oxTEZhMNx7UQY8wRoXM3rUcc6Sr5jfWfq1HJq9ZGeRRxRLJYF0Mi4tAGatrC/tdnuIhpTue1PWZ+FrxPiswXocoSheu0YPXyvHzrcGz85wSQHqMfCclZcGkCXg/tRtc9pHn05fbmCYx6lI2ePrP43BZ4PBmcO0JCywsPq7KFpGBNWJABiFh7ysWUC1N8pGe+ykUJ63rrnIu3PJXmNI7DFQgG67B/AzHn6MQljxBAA0QfosjxgbjwdTrG7b7h/wdQwk/MHKJNaMkBVW+ux7F/CjG5TNgljyHfOALW+XuIAAGp6dMfUMIs0CmMAzXkC1PvNJAcHUHNQLb6rxTQM3QvzdZyGZWVodFgyUMcBAnSpDMXIpv6+ZFNvtx0t3xNs+9ImC470whg3PkyAdOT1W1pbQ6B9TnQEi14PM450PhyacqMD0LuHJ/deLRWgyyZDmiNnfVmJJkYeLOgA9P7rR/nLHywYoEtlUAY9DHIaXQhHzDxMYnQAevfz5/nVF8/pABTKYiwVdr0YWafKroVTOk4GoKufvsrf/ewJe/QBU4gQIKEebFOHpKPJIN/ckwBx6bJuKgIzECGPRX2UUc9ARADC/8qw9kgC0MHkQIQ8FgXQ+6+/pHUUFtCCiseiACJ3HiigBRWPZQHUUMzmDgg5kLUHAOICQNYeAIgLAFl7ACAuAGTtAYACW1DxAEBemhvfgooHAPLS3PgWVDwAkJfmDgg5kLUHAYD6ROQjeiJhUIkjVhgAyLeIxAGATEUkDCpxACBTEQmDShwzAgg6ZAEgyEkACHISAIKcBIAgJzkAVF+q2LhoMbbUyuuLt1PGcfXZycmj9GG8OTn5NHx32ANU37LavHk1stTK38Tosck4+D0sV58/mSoQOgy+M0UYFXuA6ts1mjduRJZS+bO736Sbgeo43vBRe5ZoCmqORYRRsQeovmGseetYZDUqT7iENTuBRnfQnoHqW1abN69GVqPyhAA14uD3QqUP4+qzu+EHBTNQgDjePUzFT/yJcEk5UFKAlDiuPkt2DNYei/CpmMtR2JfVUdiXKY/ClMoTAlTHkZIfJYxIiYXzeSA+ZgTOAxXopD8PxCJ4ecKVCqK6O1gcpHMgCMoBEOQoAAQ5CQBBTgJAkJMAEOSkeABt+feOnhkU2N262H/4uHr69qlWKbWISblBKeU73lwsTCf/qfLt+HuDSKdYAN2c837aZcf6RZo9q9tv7e1c+1stnwKgTp0HClDZTds7L0yLlAJAY0GkUySAbs6PlcdZti5e2fE1bbMWL7F+3H/0r1nRnden2eqrYgnbH/Glj/8+Lh6zPx/+8kgsh4VVLstz7T/8Kss4psVrvMTf9VRVVSmtRFH++HhfvFDUVdRb1iO8Zb3cpAxTaZYsV/49a8TWib+vfFWX2EbUX/RL9cYhAnR9WmU/N+dr8cMno813+eCc8af8+f5oLTc/Zj8CINFf+6Mz/le4bDkVrOyWd+lavCbL86L8PVmF8GTleqqqqyysZFGWqhUvVHWx8rIetV5eWIYpm8W3UcvxuNXY2vH3lZexy22KfWhd99thAlR2Z5atHospmyfIH13c/PNXbAg/utgVezPb3UrMxAtF77G3K4e/vigeiO0kXHLzklH5XuXJB6BbVaPK0qd4XL5Q1cXLl/W0vWWYVQuZqnJl3Gps7fj7ylfdo7RRPK7eOEiA5AzEe43vjewvmw723/vLjy7Y3rkt/jXEcdU3Yo9lQ8Bf2JQrg3hvl3EGCxzLAcjLA7ysSNDFwLHqVM+eqhpVSoCqx+JXXdfuVg0x/1WZlGHy9+pUpign41Zja8ffV152j9ymArjxBh1FzoEUgFhCslvfnD9g78jUuhcgkSkUO9716eqx2rkVQEpqXgGkenararzdB5BaVwcg1aQFgCwn41Zja8cPgPRVT9S71eOiu3Z3/uUs3/7ND9kArcolQvZNe7oulyLRh7tVo3PF5qvWkZKsRj7vVtV4uw8gta5qCWt5yzDV2GU5GbcaWzv+3vJl93QBUt+go2gnEjfFeSAlwxX7I3+FPWW/ZMdyXZ+uZRIt+lfMCGeiD/dH9QBIK1meF62T6OI1sXh2q2pU2QtQWVcjsa3qld7rRhLMf2Q5GbcaWzv+vvLtukTyzh8fdhKdF8u/OF6Wx6v5hnUtPxApXlo9VvpGOYwvUwqWU6x5XrH692I2yovkpj70raaUr5qv8XLdqhpV9uZAZV2ivHoELevlJn2H4bKcjFuJrRP/6GF8Fce6iO+gD+OhpQoAQU4CQJCTABDkJAAEOQkAQU4CQJCTABDkJAAEOQkAQU76f/m2LmvzzHMXAAAAAElFTkSuQmCC" /><!-- --></p>
<p>The function <code>threshold_model_plot</code> plots the probability
of being the maximum bipartite graph algorithm match vs. a random one by
distance. It also plots the threshold for distance corresponding to a
probability specified through the <code>p_threshold</code> argument.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">threshold_model_plot</span>(threshold_results, <span class="at">p_threshold =</span> <span class="fl">0.50</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Example of threshold_model_plot&quot;</span>)</span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<p>This package can also be used to analyze data from a case-control
study that was originally matched. The
<code>original_compare_plot</code> function makes a density plot of the
distance for originally matched pairs. It also gives the proportion of
originally matched pairs that have a distance greater than the
threshold.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># create a variable (i.e., pair) indicating originally matched pairs</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>anifood_matched <span class="ot">&lt;-</span> anifood <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(case) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">pair =</span> <span class="fu">seq_along</span>(case)) <span class="sc">%&gt;%</span> ungroup</span></code></pre></div>
<p>In this example, 84% of original matched case-control pairs have a
distance greater than the threshold.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">original_compare_plot</span>(anifood_matched, case, pair, threshold_results)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co"># the density plot of distance between originally matched cases and controls</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>p<span class="sc">$</span>plot_density <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Example of original_compare_plot&quot;</span>)</span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co"># proportion of originally matched cases and controls with a distance greater than the threshold</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>p<span class="sc">$</span>prop_distance_gt_threshold</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">#&gt; .</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">#&gt;     FALSE      TRUE </span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co">#&gt; 0.1627907 0.8372093</span></span></code></pre></div>
</div>
<div id="create-strata-candidate-matches-for-final-analysis" class="section level2">
<h2>3. Create strata: candidate matches for final analysis</h2>
<p>The <code>make_knn_strata</code> function calculates Gower distances,
by default, for pairs formed by every case and every control for a given
exposure and creates strata by selecting the closest 250 controls for
each case (by default, can be modified through the <code>ncntls</code>
argument). Thus, for that exposure, the number of rows in data frame
equals the number of cases * 251. The data frames for all exposures are
stored in a list with a length equal to
<code>length(exp_interest)</code>.</p>
<p>This step can be computationally intensive depending on the amount of
data. <code>furrr::future_map()</code> can be used so that the
computation can be easily adjusted to use multiple cores on your local
computer or a high-performance computing (HPC). More information is
provided <a href="#run-the-analysis-on-your-local-computer-or-hpc">below</a>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>strata1 <span class="ot">&lt;-</span> <span class="fu">future_map</span>(exp_interest, make_knn_strata,  <span class="at">rmvars =</span> excl_vars, <span class="at">matchvars =</span> exp_match, <span class="at">df =</span> anifood) <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="fu">setNames</span>(exp_interest)</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">length</span>(strata1) <span class="sc">==</span> <span class="fu">length</span>(exp_interest)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co"># rows in a matched data set</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="fu">all.equal</span>(anifood <span class="sc">%&gt;%</span> <span class="fu">filter</span>(case <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> NROW <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">*</span><span class="st">`</span>(<span class="dv">250</span> <span class="sc">+</span> <span class="dv">1</span>), <span class="fu">NROW</span>(strata1[[<span class="dv">1</span>]]))</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>In the <code>make_knn_strata</code> function, a data frame should be
supplied to the <code>rmvars</code> argument (see <code>excl_vars</code>
above). That data frame should include two variables: <em>exp_var: a
character variable (only a single exposure in a row), and </em>rm_vars:
a character variable that contains the names of the variables that are
not adjusted for. Names are separated by a space.</p>
</div>
<div id="prepare-final-matched-sets-for-analysis" class="section level2">
<h2>4. Prepare final matched sets for analysis</h2>
<p>For a given exposure, the <code>make_analysis_set</code> function
selects the closest 20 controls for each case; subset these 20 to those
that fall within the threshold; collapse strata that share the same
controls; and remove strata without any control.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>strata2 <span class="ot">&lt;-</span> <span class="fu">future_map</span>(exp_interest, make_analysis_set, <span class="at">stratified_data =</span> strata1, <span class="at">data =</span> anifood, <span class="at">maxdist =</span> threshold_results<span class="sc">$</span>threshold) <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(exp_interest)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">#&gt; exp01</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co">#&gt; exp09</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co">#&gt; exp27</span></span></code></pre></div>
<p>The <code>finalize_data</code> function ensures that a control
retained in a data frame is used once; removes strata without any case
or any control. In this process, priority is given to the smallest
strata then smallest distance if a control is matched to multiple cases
(i.e., that control exists in multiple strata).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>strata3 <span class="ot">&lt;-</span> <span class="fu">finalize_data</span>(strata2)</span></code></pre></div>
<p>The last step is to exclude exposures, if any, with odds ratios that
are not estimable (e.g., none of cases and controls was exposed). For
example, <code>exp09</code> in this example.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># exposures to which neither cases nor controls were exposed</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>strata3 <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="cf">function</span>(dfm) dfm <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>                            <span class="fu">mutate</span>(<span class="at">case =</span> <span class="fu">as.character</span>(case), <span class="at">exp =</span> <span class="fu">as.character</span>(exp)) <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>                            <span class="fu">filter</span>(case <span class="sc">!=</span> <span class="st">&quot;&quot;</span> <span class="sc">&amp;</span> exp <span class="sc">!=</span> <span class="st">&quot;&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>                            <span class="fu">with</span>(<span class="fu">table</span>(case, exp))) <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="cf">function</span>(x) x<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="cf">function</span>(x) {sum <span class="ot">=</span> <span class="fu">sum</span>(x); length <span class="ot">=</span> <span class="fu">length</span>(x); <span class="fu">cbind</span>(sum, length)}) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  <span class="fu">do.call</span>(rbind,.) <span class="sc">%&gt;%</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>  as.data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var =</span> <span class="fu">names</span>(strata3)) <span class="sc">%&gt;%</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>  <span class="fu">filter</span>(sum <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">|</span> length <span class="sc">&lt;</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(var) <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>  unclass <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  unlist <span class="ot">-&gt;</span> expvars_invalid</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>expvars_invalid</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a><span class="co">#&gt; character(0)</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a><span class="co"># none exposed and odds ratio cannot be estimated</span></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>strata3[[<span class="st">&quot;exp09&quot;</span>]] <span class="sc">%&gt;%</span> <span class="fu">with</span>(<span class="fu">table</span>(case, exp))</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a><span class="co">#&gt;     exp</span></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a><span class="co">#&gt; case   0   1</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a><span class="co">#&gt;    0 236   0</span></span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a><span class="co">#&gt;    1 231   1</span></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a>data_final <span class="ot">&lt;-</span> strata3[<span class="fu">setdiff</span>(<span class="fu">names</span>(strata3), expvars_invalid)]</span></code></pre></div>
</div>
<div id="calculate-odds-ratios" class="section level2">
<h2>5. Calculate odds ratios</h2>
<div id="mantelhaenszel-test-and-fishers-exact-test" class="section level3">
<h3>5.1 Mantel–Haenszel test and Fisher’s exact test</h3>
<p>The <code>test_mh</code> function performs the Mantel–Haenszel test
for data frame with more than one stratum and the Fisher’s exact test
for a data frame with only one stratum.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>or_mh <span class="ot">&lt;-</span> <span class="fu">future_map</span>(data_final, <span class="cf">function</span>(dfm) <span class="fu">with</span>(dfm, <span class="fu">test_mh</span>(<span class="at">case =</span> case, <span class="at">exp =</span> exp, <span class="at">strata =</span> strata)))</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>or_mh[[<span class="st">&quot;exp01&quot;</span>]]</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">#&gt; $p.value</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co">#&gt; [1] 0.727695</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co">#&gt; $conf.int</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co">#&gt; [1] 0.7440193 1.5998105</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co">#&gt; attr(,&quot;conf.level&quot;)</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co">#&gt; [1] 0.95</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="co">#&gt; $estimate</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="co">#&gt; common odds ratio </span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="co">#&gt;          1.091004 </span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="co">#&gt; $null.value</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="co">#&gt; common odds ratio </span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co">#&gt;                 1 </span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="co">#&gt; $alternative</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="co">#&gt; [1] &quot;two.sided&quot;</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="co">#&gt; $method</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="co">#&gt; [1] &quot;Mantel-Haenszel chi-squared test with continuity correction&quot;</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="co">#&gt; $data.name</span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="co">#&gt; [1] &quot;case and exp and strata&quot;</span></span></code></pre></div>
<p>However, when the number of exposed is small, this method may yield
an infinite result.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>data_final[[<span class="st">&quot;exp27&quot;</span>]] <span class="sc">%&gt;%</span> <span class="fu">select</span>(case, exp) <span class="sc">%&gt;%</span> table</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co">#&gt;     exp</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">#&gt; case   0   1</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">#&gt;    0 236   0</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="co">#&gt;    1 231   1</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>or_mh[[<span class="st">&quot;exp27&quot;</span>]]</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="co">#&gt; $p.value</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="co">#&gt; [1] 0.9698768</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="co">#&gt; $conf.int</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="co">#&gt; [1] NaN NaN</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a><span class="co">#&gt; attr(,&quot;conf.level&quot;)</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a><span class="co">#&gt; [1] 0.95</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a><span class="co">#&gt; $estimate</span></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a><span class="co">#&gt; common odds ratio </span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a><span class="co">#&gt;               Inf </span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a><span class="co">#&gt; $null.value</span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a><span class="co">#&gt; common odds ratio </span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a><span class="co">#&gt;                 1 </span></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a><span class="co">#&gt; $alternative</span></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a><span class="co">#&gt; [1] &quot;two.sided&quot;</span></span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a><span class="co">#&gt; $method</span></span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a><span class="co">#&gt; [1] &quot;Mantel-Haenszel chi-squared test with continuity correction&quot;</span></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a><span class="co">#&gt; $data.name</span></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a><span class="co">#&gt; [1] &quot;case and exp and strata&quot;</span></span></code></pre></div>
</div>
<div id="conditional-logistic-regression" class="section level3">
<h3>5.2 Conditional logistic regression</h3>
<p>Conditional logistic regression gives results similar to those from
Mantel–Haenszel test, but may also give less than ideal results when few
participants are exposed.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>results_clogit <span class="ot">&lt;-</span> <span class="fu">future_map</span>(data_final, <span class="cf">function</span>(dfm){<span class="fu">clogit</span>(case <span class="sc">~</span> exp <span class="sc">+</span> <span class="fu">strata</span>(strata) , <span class="at">data =</span> dfm)}) </span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>results_clogit[[<span class="st">&quot;exp27&quot;</span>]] <span class="sc">%&gt;%</span> <span class="fu">summary</span>() <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">$</span><span class="st">`</span>(conf.int)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co">#&gt;      exp(coef)   exp(-coef) lower .95 upper .95</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="co">#&gt; exp1  11766455 8.498736e-08         0       Inf</span></span></code></pre></div>
<p>When combined with multiple imputation, we recommend a Bayesian
approach.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>results_stan_clogit <span class="ot">&lt;-</span> <span class="fu">future_map</span>(data_final, <span class="cf">function</span>(dfm) {</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>  dfm<span class="sc">$</span>strata <span class="ot">&lt;-</span> <span class="fu">factor</span>(dfm<span class="sc">$</span>strata)</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>  <span class="fu">stan_clogit</span>(case <span class="sc">~</span> exp, </span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>              <span class="at">data =</span> dfm, </span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>              <span class="at">strata =</span> strata,</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>              <span class="co"># rstanarm suggests us specifying priors even if they are the </span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>              <span class="co"># defaults because they might change in the future</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>              <span class="at">prior =</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">4</span>),</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>              <span class="co">#default: prior = normal(autoscale = TRUE),</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>              <span class="at">prior_covariance =</span> <span class="fu">decov</span>(),</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>              <span class="at">iter =</span> <span class="dv">100</span>,</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>              <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>              <span class="at">prior_PD =</span> <span class="cn">FALSE</span>)}) <span class="co"># for speed only</span></span></code></pre></div>
</div>
<div id="penalized-logistic-regression" class="section level3">
<h3>5.3 Penalized logistic regression</h3>
<p>When the number of participants being exposed is small, <a href="https://CRAN.R-project.org/package=logistf/index.html">Firth’s
bias-Reduced penalized-likelihood logistic regression</a> can also be
used (1).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">library</span>(logistf)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co"># regression coefficients</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>coef_logistf <span class="ot">&lt;-</span> <span class="fu">future_map</span>(data_final, <span class="cf">function</span>(dfm){</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">unique</span>(dfm[[<span class="st">&quot;strata&quot;</span>]])) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>        x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(case <span class="sc">~</span> exp, <span class="at">data =</span> dfm)</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>        plconf <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">&quot;exp&quot;</span>, <span class="fu">colnames</span>(x))</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>        o <span class="ot">&lt;-</span> <span class="fu">logistf</span>(case <span class="sc">~</span> exp, <span class="at">data =</span> dfm, <span class="at">plconf =</span> plconf) <span class="sc">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>                 <span class="st">`</span><span class="at">[</span><span class="st">`</span>(<span class="fu">c</span>(<span class="st">&quot;terms&quot;</span>, <span class="st">&quot;coefficients&quot;</span>, <span class="st">&quot;ci.lower&quot;</span>, <span class="st">&quot;ci.upper&quot;</span>, <span class="st">&quot;prob&quot;</span>, <span class="st">&quot;call&quot;</span>, <span class="st">&quot;loglik&quot;</span>, <span class="st">&quot;model&quot;</span>))</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>        x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(case <span class="sc">~</span> exp <span class="sc">+</span> strata, <span class="at">data =</span> dfm)</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>        plconf <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">&quot;exp&quot;</span>, <span class="fu">colnames</span>(x))</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>        o <span class="ot">&lt;-</span> <span class="fu">logistf</span>(case <span class="sc">~</span> exp <span class="sc">+</span> strata, <span class="at">data =</span> dfm, <span class="at">plconf =</span> plconf) <span class="sc">%&gt;%</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>                 <span class="st">`</span><span class="at">[</span><span class="st">`</span>(<span class="fu">c</span>(<span class="st">&quot;terms&quot;</span>, <span class="st">&quot;coefficients&quot;</span>, <span class="st">&quot;ci.lower&quot;</span>, <span class="st">&quot;ci.upper&quot;</span>, <span class="st">&quot;prob&quot;</span>, <span class="st">&quot;call&quot;</span>, <span class="st">&quot;loglik&quot;</span>, <span class="st">&quot;model&quot;</span>))</span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>    }</span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>},</span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="at">.progress =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a><span class="co"># odds ratios</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>or_logistf <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(coef_logistf), <span class="cf">function</span>(var_name){</span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a>  coef_logistf[[var_name]] <span class="sc">%&gt;%</span></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a>    <span class="st">`</span><span class="at">[</span><span class="st">`</span>(<span class="fu">c</span>(<span class="st">&quot;terms&quot;</span>, <span class="st">&quot;coefficients&quot;</span>, <span class="st">&quot;ci.lower&quot;</span>, <span class="st">&quot;ci.upper&quot;</span>, <span class="st">&quot;prob&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a>    bind_cols <span class="sc">%&gt;%</span></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">&quot;exp&quot;</span>, terms)) <span class="sc">%&gt;%</span></span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">variable =</span> var_name, <span class="at">or =</span> <span class="fu">exp</span>(coefficients), <span class="at">ci.lower =</span> <span class="fu">exp</span>(ci.lower), <span class="at">ci.upper =</span> <span class="fu">exp</span>(ci.upper)) <span class="sc">%&gt;%</span></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a>  <span class="fu">select</span>(variable, terms, or, ci.lower, ci.upper, prob)}) <span class="sc">%&gt;%</span></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">names</span>(coef_logistf))</span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a><span class="co"># odds ratio for exp27</span></span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a>or_logistf[[<span class="st">&quot;exp27&quot;</span>]] </span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 6</span></span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a><span class="co">#&gt;   variable terms    or ci.lower ci.upper  prob</span></span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a><span class="co">#&gt; 1 exp27    exp1   3.30    0.172     486. 0.434</span></span></code></pre></div>
</div>
</div>
<div id="calculate-population-attributable-fraction-paf" class="section level2">
<h2>6. Calculate population attributable fraction (PAF)</h2>
<p>PAF can be estimated using the method described by Bruzzi and
colleagues (3). We implemented this method in <code>get_paf</code>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="co"># prepare a data frame for calculating PAF</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>df_or <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(or_logistf)</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>df_or</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 6</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="co">#&gt;   variable terms    or ci.lower ci.upper  prob</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a><span class="co">#&gt; 1 exp01    exp1   1.09    0.744     1.60 0.656</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="co">#&gt; 2 exp09    exp1   3.54    0.182   523.   0.408</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="co">#&gt; 3 exp27    exp1   3.30    0.172   486.   0.434</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># point estimate of PAF</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>paf <span class="ot">&lt;-</span> <span class="fu">get_paf</span>(<span class="at">df_or =</span> df_or, <span class="at">which_or =</span> or, <span class="at">exp_var =</span> variable, <span class="at">exp_level =</span> terms, <span class="at">df_matched =</span> data_final)</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>paf</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 2</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="co">#&gt;    paf_or variable</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co">#&gt;     &lt;dbl&gt; &lt;chr&gt;   </span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="co">#&gt; 1 0.0549  exp01   </span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a><span class="co">#&gt; 2 0.00309 exp09   </span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co">#&gt; 3 0.00300 exp27</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a><span class="co"># lower confidence limit of PAF</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>paf_ci.lower <span class="ot">&lt;-</span> <span class="fu">get_paf</span>(<span class="at">df_or =</span> df_or, <span class="at">which_or =</span> ci.lower, <span class="at">exp_var =</span> variable, <span class="at">exp_level =</span> terms, <span class="at">df_matched =</span> data_final)</span></code></pre></div>
</div>
<div id="multiple-imputation-of-missingness" class="section level2">
<h2>7. Multiple imputation of missingness</h2>
<p>When the case-control data contains a large proportion of
missingness, multiple imputation may be useful.</p>
<ul>
<li><p>For regression coefficients generated by Mantel–Haenszel test or
conditional logistic regression, Rubin’s rule may be proper for
combining the results (4).</p></li>
<li><p>Originally in our paper (2), we used Firth’s bias-Reduced
penalized-likelihood logistic regression, but the regression
coefficients are not normally distributed. The results from imputed data
sets should therefore be combined using penalized likelihood profiles
(5). Penalized likelihood profiles are implemented in
<code>logistf::CLIP.confint()</code>, but the function was developed to
combine results from imputed data sets that have the same structure.
However, if we impute the original case-control data, and then apply
nearest-neighbors matching to the imputed data, the final analytic data
sets for a given exposure could have inconsistent structures because
they could have different numbers of strata.</p></li>
</ul>
<p>Thus, we modified the <code>logistf::CLIP.confint()</code> to
accommodate our method. The modified function is included in version
1.0.1 of the <code>nncc</code> package along with a compatible, bundled
version of the <code>logistf</code> package version 1.24, and the
function is called <code>CLIP.confint.difflevel()</code>. Please cite
the original paper (4) and/or the <a href="https://CRAN.R-project.org/package=logistf/index.html">logistf
package</a> if you use this modified function for publication.</p>
<ul>
<li>Now we recommend a Bayesian approach, based on drawing samples from
the stacked posteriors of the model run on each imputed data set.</li>
</ul>
</div>
<div id="helper-function-cacheit" class="section level2">
<h2>8. Helper function <code>cacheit()</code></h2>
<p>When the number of exposures of interest or the sample size of the
original case-control study is large, it may be time-consuming for some
analyses (e.g., strata creation). You may not want to have the same code
evaluated again when you run your analysis later. The helper function
<code>cacheit()</code> caches the results for you. Specifically, before
your run <code>cacheit()</code>, create a folder named “cache” in the
working directory of your project. When you run
<code>cacheit(&quot;abc&quot;, code)</code> for the first time, it saves the
results of your code as abc.rds in the <code>cache</code> folder; next
time, when you run the code, it directly read the saved results in
without evaluating your code.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>strata1 <span class="ot">&lt;-</span> <span class="fu">cacheit</span>(<span class="st">&quot;abc&quot;</span>,</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>                   <span class="fu">future_map</span>(exp_interest, make_knn_strata,  <span class="at">rmvars =</span> excl_vars, <span class="at">matchvars =</span> exp_match, <span class="at">df =</span> anifood) <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>  <span class="fu">setNames</span>(exp_interest),</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  <span class="at">clearcache =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="run-the-analysis-on-your-local-computer-or-hpc" class="section level2">
<h2>9. Run the analysis on your local computer or HPC</h2>
<p>Considering the intensive computation for this approach, especially
when multiple imputation is conducted, a <a href="https://CRAN.R-project.org/package=future/vignettes/future-1-overview.html">future</a>
can be used to accelerate the analysis. Below we briefly introduce the
use of futures on your local multi-core computer and HPC.</p>
<div id="local-computer" class="section level3">
<h3>9.1 local computer</h3>
<p>If you have a multi-core computer, the following code can assign a
specified number of cores for the analysis.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">library</span>(nncc)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="fu">library</span>(future.batchtools)</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="co"># the workers argument is used to define the number of cores for the analysis. By default, all cores will be used.</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> <span class="dv">3</span>)</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>strata1 <span class="ot">&lt;-</span> <span class="fu">future_map</span>(exp_interest, make_knn_strata,  <span class="at">rmvars =</span> excl_vars, <span class="at">matchvars =</span> exp_match, <span class="at">df =</span> anifood) <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>  <span class="fu">setNames</span>(exp_interest)</span></code></pre></div>
</div>
<div id="hpc" class="section level3">
<h3>9.2 HPC</h3>
<p>To run futures on HPC, you may need a template file, a job script,
and a R script. The template file and the job script are created using a
Linux application such as nano and saved as .sh files.</p>
<p>There are some exemplary template files <a href="https://github.com/mllg/batchtools/tree/master/inst/templates">here</a>.
The template file should be saved as <code>batchtools.sge.tmpl</code> in
your current working directory or as <code>.batchtools.sge.tmpl</code>
in your home directory on the HPC. Below is an example of a template
file for Sun Grid Engine.</p>
<pre><code>#!/bin/bash

## name of the job
#$ -N &lt;%= job.name %&gt;

## tell the queue system to use the current directory as the working directory
## Or else the script may fail as it will execute in your top level home directory /home/username
#$ -cwd

## Use environment variables
#$ -V

## specify a queue
#$ -q &lt;%= resources$queue %&gt;

## free to add other modules if necessary
module load R/3.6.2

Rscript -e &#39;batchtools::doJobCollection(&quot;&lt;%= uri %&gt;&quot;)&#39;
exit 0</code></pre>
<p>Below is an example of a job script to be submitted to the scheduler
through a shell:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co">#!/bin/bash -l</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="co"># name of the job is helloR</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="co">#$ -N helloR</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co">#$ -cwd</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co">#$ -V</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a><span class="co">#$ -pe smp 2-12</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a><span class="co">#$ -q all.q</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>module load R<span class="sc">/</span><span class="dv">3</span>.<span class="fl">6.2</span></span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a><span class="co"># to execute fugure-map.R</span></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>Rscript future<span class="sc">-</span>map.R</span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>exit <span class="dv">0</span></span></code></pre></div>
<p>The R code looks like:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="fu">library</span>(future.batchtools)</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="fu">plan</span>(batchtools_sge)</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a><span class="fu">future_map</span>(<span class="sc">&lt;</span>a_list_or_vector<span class="sc">&gt;</span>, <span class="cf">function</span>(x){...}, <span class="at">.progress =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="references" class="section level3">
<h3>References:</h3>
<ol style="list-style-type: decimal">
<li>Firth D. Bias reduction of maximum likelihood estimates. Biometrika
1993;80:27-38.</li>
<li>Bruzzi P, Green SB, Byar DP, et al. Estimating the population
attributable risk for multiple risk factors using case-control data. Am
J Epidemiol 1985;122(5):904-14.</li>
<li>Cui Z, Marder EP, Click ES, Hoekstra RM, Bruce BB. Nearest-neighbors
matching for case-control study analyses: better risk factor
identification from a study of sporadic campylobacteriosis in the United
States. Epidemiology 2022;33(5):633-41.<br />
</li>
<li>Rubin DB. Multiple imputation for nonresponse in surveys. New York:
John Wiley and Sons; 1987.</li>
<li>Heinze G, Ploner M, Beyea J. Confidence intervals after multiple
imputation: combining profile likelihood information from logistic
regressions. Stat Med 2013;32(29):5062-76.</li>
</ol>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
